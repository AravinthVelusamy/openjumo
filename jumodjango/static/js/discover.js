JUMO.Discover={speed:10,tagMax:1,numRows:3,numColumns:3,maxOrgsPerRow:2,defaultOrgWidth:167,parent:JUMO,popup:JUMO.Modules.Popup,initialize:function(a,b,c){if(this.user===void 0)this.user={};this.trackFunnel("Account Created");this.panel=2;this.recommendedIssues=this.randomiseRecommendedOrgs(a);this._init_following=JUMO.Util.clone(b,[]);this.following=b;this.setupMouseEvts();if(JUMO.user&&JUMO.user.id&&(this.user=JUMO.user,this._gotoSecondPanel(JUMO.user.name),this.doNotShowPopup=!0,c&&this.parent.FormMaker.locationToString(c)))this.locationVal=
c,this.getNearbyOrgs(this.locationVal)},trackFunnel:function(a,b){JUMO.Modules.Tracking.trackFunnel("New User: "+a,b)},clickEntity:function(a,b){var c=this._getItem(b.attr("data-id"),b.find(".name").text()||b.text(),b.attr("data-type"),b),d=b.find(".notinterested");b.parent().attr("id")!="rec_types"&&(d.hasClass("checked")?(d.removeClass("checked"),d.removeClass("disabled"),d.find("span:first").css({"background-position":"0 0"}),d.find("span:last").text("click to follow"),d.find("input:first").attr("checked",
!1),this.removeFollowing(c)):(d.addClass("checked"),d.addClass("disabled"),d.find("span:first").css({"background-position":"0 -50px"}),d.find("span:last").text("following"),d.find("input:first").attr("checked",!0),this.addFollowing(c)))},setupMouseEvts:function(){var a=this;jQuery("#get_started").click(function(){a.getStarted(jQuery(this))});jQuery("li.org",jQuery("#issues")[0]).live("click",function(b){var c=jQuery(this);a.clickEntity(b,c)});jQuery("#change_account").click(function(){FB.logout();
JUMO.Util.fbLogin(jQuery(this).parent())});jQuery("#next").click(function(){if(a.panel==2){a.user.new_user_survey={};jQuery("#survey .survey_row").each(function(b,d){var e=jQuery(d),f=e.find("input:eq(0)").attr("name"),e=e.find(":checked").length>0?e.find(":checked").val():0;a.user.new_user_survey[f]=e});var b=Object.keys(a.user.new_user_survey).filter(function(b){return a.user.new_user_survey[b]>0});if(!a.user.new_user_survey||b.length<1)return a.showError("please select at least one option");jQuery("#next").text("Done!");
jQuery("#currentstep").text("3/3").show();a.hideError();a.trackFunnel("Selected Issue Areas",a.user.new_user_survey);a.gotoThirdPanel(jQuery(this),function(){jQuery("#step li:eq(2)").addClass("filled")})}else if(a.panel==3){if(a.following){if(a.following.filter(function(a){return a.type=="org"}).map(function(a){return a.id}).length<1)return a.showError("please follow at least one issue or project")}else return a.showError("please follow at least one issue or project");a.hideError();return a.followSelectedEntities(function(){window.location=
a.doNotShowPopup?"/":"/?new_user=true"},jQuery(this))}})},buildRecommendedIssuesAndOrgs:function(a){var b=this,c=jQuery("#issues ul.rec");c.html("");var d=a.filter(function(a){return b.user.new_user_survey[a.name]&&b.user.new_user_survey[a.name]>1}),a=a.filter(function(a){return b.user.new_user_survey[a.name]&&b.user.new_user_survey[a.name]>0&&b.user.new_user_survey[a.name]<2});jQuery.fn.append.apply(c,[d,a].map(function(a){return a!==void 0&&a.length>0?a.map(function(a){return a!==void 0?b.buildRecommendedOrgRow(a.issues,
a.name):!1}):!1}).reduce(function(a,b){return a.concat(b)},[]));this.buildNearbyInterests(this.nearbyOrgs,c)},buildNearbyInterests:function(a,b){if(this.nearbyOrgs){var c=this,d=jQuery("#templates .follow_row").clone();d.find(".head .name").html(this.getWhiteImageForIssue("nearby")+"Near Me");var e=this.parent.FormMaker.locationToString(this.locationVal);d.find(".head").append('<div class="locationdiv">my location: <input value=\''+e+"'></input></div>");this.parent.FormMaker.makeLocationDiv(d.find(".head input"),
this);d.find(".issues").hide().end().find(".orgs").css({"border-left":"0px",width:"99.7%",left:"0px"});this.drawNearbyOrgs(d,a);d.find(".org_container").css({width:this.getOrgContainerWidth(170,a.length)});d.find(".right_arrow").click(function(){c.animateOrgsRight({name:"nearby",orgs:c.nearbyOrgs},d)});b.append(d)}},drawNearbyOrgs:function(a,b){var c=this;b&&b.length>0&&(a.find(".follow_boxes li.orgs ul").html(""),jQuery.fn.append.apply(a.find(".follow_boxes li.orgs ul"),b.map(function(a){if(a=c.buildRecommendedOrg(a,
"nearby"))return a.css({width:"170px"}),a})))},changeOrgSelectTab:function(a,b){var c=this,d=a.parent().parent().parent();a.hasClass("selected")||(a.parent().find("li").removeClass("selected"),a.addClass("selected"),d.find(".org_container").css({left:"0px"}),this.animateHideOrgs(d,function(a){var f=d.find(".orgs ul");jQuery.fn.append.apply(f,b.orgs.map(function(a){return c.buildRecommendedOrg(a,b.name)}));a(f);f.css({width:c.defaultOrgWidth*b.orgs.length+10+"px"})}))},animateHideOrgs:function(a,b){var c=
a.find(".orgs"),d=a.find(".orgs").width()<506?"506px":a.find(".orgs").width();c.animate({width:0},200,function(){var a=jQuery(this);a.find(".org").remove();c.css({display:"inline-block"});b(function(){a.animate({width:d},200)})})},buildRecommendedIssue:function(a){var b=this;return jQuery("#templates .issue").clone().attr({"data-id":a.id,"data-type":"issue"}).html(a.name).click(function(){b.changeOrgSelectTab(jQuery(this),a,0)})},getFollowHTML:function(a){return'<input class="styled" type="checkbox"'+
(a?"checked":"")+"/><span>"+(a?"following":"click to follow")+"</span>"},_buildRecommendedOrg:function(a,b){var c=this,d=this.isOrgBeingFollowed(a.id),e=this.getFollowHTML(d);return jQuery("#templates .org").clone().attr({"data-id":a.id,"data-type":"org"}).addClass(d?"checked":"").find(".more_info").attr({"data-id":a.id}).hide().end().find(".name").text(a.name).end().find(".orgphoto").attr({src:this._getOrgImgUrl(a)}).end().find(".tags").text(this._getTags(a.tags,b)).end().find(".notinterested").html(e).addClass(d?
"disabled":"").end().find(".follow").click(function(){c.followOrgAndRefresh(a,jQuery(this))}).end().find(".notInterested").click(function(){c.followOrgAndRefresh(a,jQuery(this))}).end()},buildRecommendedOrg:function(a,b){this.recommendedItems.push(a.id);return this._buildRecommendedOrg(a,b)},buildRecommendedOrgRow:function(a,b){var c=this,d=jQuery("#templates .follow_row").clone();this.recommendedItems=[];this.appendedOrgs=0;this.extraOrgs={};d.find(".head .name").html(this.getWhiteImageForIssue(b)+
b);jQuery.fn.append.apply(d.find(".follow_boxes li.issues ul"),a.slice(0,5).map(function(a){return c.recommendedItems.indexOf(a.id)<0?(c.recommendedItems.push(a.id),c.buildRecommendedIssue(a)):!1}));a!==void 0&&a[0]!==void 0&&(jQuery.fn.append.apply(d.find(".follow_boxes li.orgs ul"),a[0].orgs.map(function(b){return c.buildRecommendedOrg(b,a[0].name)})),d.find(".follow_boxes li.orgs ul").css({width:this.getOrgContainerWidth(c.defaultOrgWidth,a[0].orgs.length)}));d.find(".issues .issue:eq(0)").addClass("selected");
d.find(".right_arrow").click(function(){c.animateOrgsRight(a,d)});return d},getOrgContainerWidth:function(a,b){return a*b+10+"px"},animateOrgsRight:function(a,b){b.find(".orgs");var c=b.find(".org_container"),d=Number(c.css("left").replace("px","")),e=b.find(".orgs").width()<506?506:b.find(".orgs").width();d-=e;Math.abs(d)>=c.width()&&(d=0);c.animate({left:d+"px"},300)},refreshRecommendedOrgs:function(a,b,c,d,e){var f=this,g=b.find(".issue.selected").attr("data-id"),h=b.find(".issue.selected").text(),
d=b.find(".org:last").attr("data-id"),a=c||a.filter(function(a){return a.id==g})[0];a.orgs.map(function(a){return a.id}).indexOf(d);var i=a.orgs;this.animateHideOrgs(b,function(a){var c=b.find(".orgs ul");jQuery.fn.append.apply(c,i.map(function(a){a=f.buildRecommendedOrg(a,h);e&&a.css({width:e});return a}));a(c)})},getNearbyOrgs:function(a,b){var c=this;a&&JUMO.Util.postJSON("org/fetch_centroid/",{lat:a.latitude,lon:a.longitude,limit:8},function(a){if(Number(a.error_code)<1&&a.result)c.nearbyOrgs=
JSON.parse(a.result),b&&b(c.nearbyOrgs)})},buildSurveyRow:function(a){return jQuery("#templates .survey_row").clone().find(".text").html(this.getImageForIssue(a.toLowerCase())+a).end().find("input").attr({name:a}).end()},buildSurvey:function(a){var b=this;jQuery.fn.append.apply(jQuery("#survey ul.rec"),a.map(function(a){if(a!==void 0&&a.name!==void 0)return b.buildSurveyRow(a.name)}))},setStepUI:function(a){jQuery("#step li").removeClass("filled");jQuery("#step li:eq("+(a-2)+")").addClass("checked");
jQuery("#step li:eq("+(a-1)+")").removeClass("checked").addClass("filled")},_gotoSecondPanel:function(){this.gotoSecondPanel(function(){jQuery("#step li:eq(1)").addClass("filled")})},gotoSecondPanel:function(a){this.panel=2;a();this.setStepUI(this.panel)},gotoThirdPanel:function(a,b){var c=this;this.panel=3;b();this.setStepUI(this.panel);this.buildRecommendedIssuesAndOrgs(this.recommendedIssues);jQuery("#signup, #survey").animate({width:"hide"},this.speed,function(){jQuery("#issues").animate({width:"show"},
c.speed,function(){jQuery(window).scrollTop(0)})});jQuery("#following").show()},_setupLocationForThirdPanel:function(a){if(!this.setupLocationForThirdPanel)this.parent.FormMaker.locationToString(this.locationVal),this.parent.FormMaker.makeLocationDiv(jQuery("#location_org input"),this),this.setLocationVal(this.locationVal,jQuery("#location_org input"),a),this.setupLocationForThirdPanel="done"},makeLocationForm:function(a){var b=this.parent.FormMaker.locationToString(a);b!==void 0?(this.locationVal=
a,a=jQuery("#templates .location_form").clone(),a.find(".loc span").text(b)):(a=jQuery("#templates .tweet_form").clone(),this.parent.FormMaker.makeLocationDiv(a.find("input"),this));jQuery("#location").html(a)},_getItem:function(a,b,c,d){return{id:a,name:b?JUMO.Util.trim(b):a,type:c,jObj:d}},editLocation:function(a){this.parent.FormMaker.makeLocationDiv(jQuery(a).parent().html('<input placeholder="enter your location" id="m_location" type="text" style="width:220px;" value=""/>').find("input"),this)},
_getTags:function(a,b){return a===void 0?"":a instanceof Array?a.filter(function(a){return a!=b}).slice(0,this.tagMax).join(", "):a.context?a.context.slice(0,this.tagMax).map(function(a){return a.name}).join(", "):""},_getOrgImgUrl:function(a){if(a.pic_url!==void 0&&a.pic_url.length>0)return a.pic_url;else if(a.img_url!==void 0&&a.img_url.length>0)return a.img_url;else if(a.facebook_id)return"http://graph.facebook.com/"+a.facebook_id+"/picture?type=large";else if(a.fb_id)return"http://graph.facebook.com/"+
a.fb_id+"/picture?type=large";return"/static/img/missing_profile_photo.png"},saveSurveyResults:function(a,b){var c=this,d={},e=jQuery(a);this.parent.FormMaker.clearError(e);d.user=JSON.stringify(this.user);JUMO.Util.postJSON("user/update/",d,function(a){Number(a.error_code)<1?b():c.parent.FormMaker.showError(e,"something went wrong")})},getIssueIdsForFollowing:function(a){var b=[],c=this._init_following.map(function(a){return a.id}),d=a.filter(function(a){return a.type=="org"}).map(function(a){return a.id}).filter(function(a){return c.indexOf(a)<
0});this.recommendedIssues.map(function(a){a.issues.map(function(a){a.id&&a.orgs.map(function(c){d.indexOf(c.id)>-1&&b.indexOf(a.id)<0&&b.push(a.id)})})});return b},followSelectedEntities:function(a,b){var c=this;this.parent.FormMaker.disableSubmit(b);var d=this.following.filter(function(a){return a.type=="org"}).map(function(a){return JUMO.Util.isNumeric(a.id)?Number(a.id):a.id});return JUMO.Util.postJSON("user/action/follow/",{items:d,item_type:"org",user_id:this.user.id,action:"follow"},function(e){if(e.result!==
void 0&&e.result.result>0){e=c.getIssueIdsForFollowing(c.following);c.trackFunnel("Followed Things",{"number issues followed":e.length,"number orgs followed":d.length});if(e.length>0)return JUMO.Util.postJSON("user/action/follow/",{items:e,item_type:"issue",user_id:c.user.id,action:"follow"},function(d){c.parent.FormMaker.enableSubmit(b);return d.result!==void 0&&d.result.result>0?a():c.parent.FormMaker.showParsedError(jQuery(".submit_spacer"),d)});c.parent.FormMaker.enableSubmit(b);return a()}c.parent.FormMaker.enableSubmit(b);
return c.parent.FormMaker.showParsedError(jQuery(".submit_spacer"),e)})},makeFollowingItem:function(a){var b=this;return jQuery("#templates .follow_item").clone().find(".text").text(a.name).end().find(".remove").click(function(){b.removeFollowing(a);jQuery(this).parent().slideUp(200)}).end()},randomiseRecommendedOrgs:function(a){a.map(function(a){a.issues.map(function(a){a.orgs=a.orgs.sort(function(){return 0.5-Math.random()})})});return a},setLocationVal:function(a,b){var c=this;if(a&&!(a.length<
1))!this.panel||Number(this.panel)<3?(b.parent().find(".loc").remove(),b.after('<div class="loc">'+this.parent.FormMaker.locationToString(a)+"</div>"),this.getNearbyOrgs(a)):this.getNearbyOrgs(a,function(a){c.drawNearbyOrgs(jQuery("#issues .follow_row:last"),a)}),this.locationVal=a},showUserImage:function(a,b){if(b!==void 0){var c;a.find(".profile_img").attr("src","http://graph.facebook.com/"+String(b)+"/picture?type=large").show()}},removeFollowing:function(a){a.jObj.removeClass("checked");this.following=
this.following.filter(function(b){return b.id!=a.id});(this.following===void 0||this.following.length<1)&&jQuery("#following").html("<h3>your profile</h3>follow organizations and issues to get started<br /><br />")},addFollowing:function(a){a.jObj.addClass("checked");if(this.following.map(function(a){return a.id}).indexOf(a.id)<0)return this.following.push(a)},isOrgBeingFollowed:function(a){return this.following.map(function(a){return a.id}).indexOf(a)<0?!1:!0},getImageForIssue:function(a){return"<img src='/static/img/"+
a.split(" ")[0].toLowerCase()+"_lr.png' ></img>"},getWhiteImageForIssue:function(a){return"<img src='/static/img/"+a.split(" ")[0].toLowerCase()+"_white.png' ></img>"},showError:function(a){jQuery(".submit_spacer .notification").show().text(a)},hideError:function(){jQuery(".submit_spacer .notification").hide().text("")},freezeDocHeight:function(){jQuery("#page-content .form_box").css({height:jQuery("#page-content .form_box").height()+"px",overflow:"hidden"})},unFreezeDocHeight:function(){jQuery("#page-content .form_box").css({height:"auto"})}};
